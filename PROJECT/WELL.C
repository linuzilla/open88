/*  老鼠走迷宮程式 */

#include <stdio.h>
#include <stdlib.h>
#include <conio.h>
#include <dos.h>
#include <graphics.h>
#include <time.h>

#define BackGround (WHITE)
#define LineCOLOR  (GREEN)
#define CompCOLOR  (LIGHTRED)
#define UserCOLOR  (BLUE)
#define TextCOLOR  (BLACK)
#define CursCOLOR  (BLACK)
#define BoarCOLOR  (CYAN)
#define MatcCOLOR  (LIGHTRED)


void user_move(void);
void comp_move(void);
int  checkmatch(int);
void init_well(void);
void select(void);
void outcpattern(int x, int y, char *msg, int len, int xs, int ys);

struct _player {
     char *message;
     void (*func)(void);
} player[2] = {
                 { "You win", user_move },
                 { "I Win !", comp_move }
              };

int XX, YY;
int turn = 1;
int width;
int d = 5, xx, yy;

int  well[3][3];


char msg1[]    = {
                        /* 恭 */
                0x02,0x01,0x00,
                0x03,0x81,0xc0,
                0x03,0x01,0x98,
                0x7f,0xff,0xfc,
                0x03,0x01,0x80,
                0x03,0x01,0x80,
                0x03,0x01,0x80,
                0x03,0x01,0x86,
                0xff,0xff,0xff,
                0x01,0x81,0x00,
                0x03,0x00,0x80,
                0x06,0x20,0x40,
                0x0c,0x38,0x30,
                0x18,0x30,0x1c,
                0x64,0x30,0x0f,
                0x87,0x34,0x04,
                0x06,0x32,0x20,
                0x0c,0x33,0x10,
                0x0c,0x31,0x18,
                0x18,0x31,0x8c,
                0x30,0x31,0x8c,
                0x40,0x31,0x8c,
                0x03,0xf0,0x00,
                0x00,0x60,0x00,

                        /* 喜 */
                0x00,0x1c,0x00,
                0x00,0x18,0x0c,
                0x7f,0xff,0xfe,
                0x00,0x18,0x00,
                0x00,0x18,0x30,
                0x1f,0xff,0xf8,
                0x00,0x00,0x00,
                0x08,0x00,0x30,
                0x0f,0xff,0xf8,
                0x0c,0x00,0x30,
                0x0c,0x00,0x30,
                0x0f,0xff,0xf0,
                0x0a,0x00,0xc0,
                0x01,0x00,0x80,
                0x01,0x81,0x06,
                0xff,0xff,0xff,
                0x00,0x00,0x00,
                0x08,0x00,0x30,
                0x0f,0xff,0xf8,
                0x0c,0x00,0x30,
                0x0c,0x00,0x30,
                0x0c,0x00,0x30,
                0x0f,0xff,0xf0,
                0x08,0x00,0x20,

                        /* !  */
                0x00,0x00,0x00,
                0x02,0x00,0x00,
                0x07,0x00,0x00,
                0x07,0x00,0x00,
                0x07,0x00,0x00,
                0x07,0x00,0x00,
                0x07,0x00,0x00,
                0x07,0x00,0x00,
                0x07,0x00,0x00,
                0x07,0x00,0x00,
                0x02,0x00,0x00,
                0x02,0x00,0x00,
                0x02,0x00,0x00,
                0x02,0x00,0x00,
                0x02,0x00,0x00,
                0x02,0x00,0x00,
                0x02,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x02,0x00,0x00,
                0x07,0x00,0x00,
                0x07,0x00,0x00,
                0x02,0x00,0x00,
                0x00,0x00,0x00,

                        /* 您 */
                0x04,0x10,0x00,
                0x07,0x1c,0x00,
                0x0e,0x38,0x06,
                0x0c,0x3f,0xff,
                0x18,0x61,0x86,
                0x18,0xc1,0x84,
                0x3d,0x01,0x88,
                0x6c,0x09,0xa0,
                0x4c,0x1d,0x90,
                0x8c,0x19,0x98,
                0x0c,0x31,0x8c,
                0x0c,0xc1,0x86,
                0x0d,0x0f,0x86,
                0x08,0x03,0x00,
                0x00,0x20,0x00,
                0x02,0x18,0x00,
                0x13,0x8c,0x08,
                0x13,0x06,0x44,
                0x33,0x06,0x46,
                0x33,0x00,0x43,
                0x73,0x00,0x63,
                0x63,0xff,0xe3,
                0x61,0xff,0xc0,
                0x00,0x00,0x00,

                        /* 贏 */
                0x00,0x18,0x00,
                0x00,0x0c,0x06,
                0xff,0xff,0xff,
                0x0c,0x00,0x00,
                0x0c,0x00,0x00,
                0x07,0xff,0xf8,
                0x10,0x00,0x00,
                0x1f,0xff,0xf8,
                0x18,0x00,0x18,
                0x18,0x00,0x18,
                0x1f,0xff,0xf8,
                0x00,0x00,0x04,
                0x46,0x46,0xfe,
                0x7f,0x7f,0x4c,
                0x66,0x66,0x4c,
                0x76,0x7e,0xcc,
                0x6e,0x66,0x6c,
                0x66,0x7e,0x7c,
                0x6e,0x66,0x5c,
                0x76,0x7e,0x4d,
                0x66,0x20,0x4d,
                0x46,0x74,0x85,
                0x5e,0xc2,0x87,
                0x85,0x03,0x03,

                        /* 了 */
                0x00,0x00,0x00,
                0x00,0x00,0x18,
                0x3f,0xff,0xfc,
                0x00,0x00,0x18,
                0x00,0x00,0x30,
                0x00,0x00,0x60,
                0x00,0x00,0xc0,
                0x00,0x03,0x00,
                0x00,0x0c,0x00,
                0x00,0x0c,0x00,
                0x00,0x0c,0x00,
                0x00,0x0c,0x00,
                0x00,0x0c,0x00,
                0x00,0x0c,0x00,
                0x00,0x0c,0x00,
                0x00,0x0c,0x00,
                0x00,0x0c,0x00,
                0x00,0x0c,0x00,
                0x00,0x0c,0x00,
                0x00,0x0c,0x00,
                0x00,0x0c,0x00,
                0x00,0x0c,0x00,
                0x03,0xfc,0x00,
                0x00,0x38,0x00,
                        };
char msg2[]    = {
                        /* 抱 */
                0x08,0x08,0x00,
                0x0e,0x0e,0x00,
                0x0c,0x0c,0x00,
                0x0c,0x0c,0x06,
                0x0c,0x1f,0xff,
                0x0d,0x18,0x06,
                0xff,0xb0,0x06,
                0x0c,0x40,0x66,
                0x0c,0x9f,0xf6,
                0x0c,0x18,0x66,
                0x0c,0x18,0x66,
                0x0d,0x98,0x66,
                0x1f,0x18,0x66,
                0xfc,0x1f,0xe6,
                0x6c,0x18,0x46,
                0x0c,0x18,0x3c,
                0x0c,0x18,0x08,
                0x0c,0x18,0x02,
                0x0c,0x18,0x02,
                0x0c,0x18,0x02,
                0x0c,0x18,0x03,
                0x0c,0x1f,0xff,
                0x7c,0x0f,0xfe,
                0x18,0x00,0x00,

                        /* 歉 */
                0x20,0x70,0x80,
                0x18,0x60,0xe0,
                0x0c,0xc0,0xc0,
                0x08,0x88,0xc0,
                0xff,0xfc,0xc0,
                0x19,0x81,0x86,
                0x19,0x81,0xff,
                0x7f,0xfb,0x66,
                0x19,0x9a,0x64,
                0x19,0x9c,0x68,
                0x19,0x98,0x60,
                0xff,0xfe,0x60,
                0x19,0x98,0x60,
                0x19,0x98,0x60,
                0x19,0x98,0x60,
                0x7f,0xf8,0xf0,
                0x19,0x90,0xd0,
                0x39,0xc0,0xd0,
                0x39,0xb1,0x98,
                0x59,0x99,0x88,
                0x59,0x8b,0x0c,
                0x99,0x82,0x06,
                0x19,0x84,0x07,
                0x11,0x08,0x02,

                        /* !  */
                0x00,0x00,0x00,
                0x02,0x00,0x00,
                0x07,0x00,0x00,
                0x07,0x00,0x00,
                0x07,0x00,0x00,
                0x07,0x00,0x00,
                0x07,0x00,0x00,
                0x07,0x00,0x00,
                0x07,0x00,0x00,
                0x07,0x00,0x00,
                0x02,0x00,0x00,
                0x02,0x00,0x00,
                0x02,0x00,0x00,
                0x02,0x00,0x00,
                0x02,0x00,0x00,
                0x02,0x00,0x00,
                0x02,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x02,0x00,0x00,
                0x07,0x00,0x00,
                0x07,0x00,0x00,
                0x02,0x00,0x00,
                0x00,0x00,0x00,

                        /* 您 */
                0x04,0x10,0x00,
                0x07,0x1c,0x00,
                0x0e,0x38,0x06,
                0x0c,0x3f,0xff,
                0x18,0x61,0x86,
                0x18,0xc1,0x84,
                0x3d,0x01,0x88,
                0x6c,0x09,0xa0,
                0x4c,0x1d,0x90,
                0x8c,0x19,0x98,
                0x0c,0x31,0x8c,
                0x0c,0xc1,0x86,
                0x0d,0x0f,0x86,
                0x08,0x03,0x00,
                0x00,0x20,0x00,
                0x02,0x18,0x00,
                0x13,0x8c,0x08,
                0x13,0x06,0x44,
                0x33,0x06,0x46,
                0x33,0x00,0x43,
                0x73,0x00,0x63,
                0x63,0xff,0xe3,
                0x61,0xff,0xc0,
                0x00,0x00,0x00,

                        /* 輸 */
                0x10,0x01,0xc0,
                0x1c,0x01,0x80,
                0x19,0x03,0x40,
                0xff,0x86,0x20,
                0x18,0x0c,0x18,
                0x18,0x18,0x0c,
                0xff,0x20,0x07,
                0x99,0x4f,0xf2,
                0x99,0x00,0x00,
                0x99,0x23,0x04,
                0xff,0x3f,0xa7,
                0x99,0x33,0x36,
                0x99,0x33,0x26,
                0x99,0x33,0x26,
                0xff,0x3f,0x26,
                0x99,0x33,0x26,
                0x18,0x33,0x26,
                0x19,0x33,0x26,
                0xff,0xbf,0x26,
                0x18,0x33,0x26,
                0x18,0x33,0x06,
                0x18,0x63,0x06,
                0x18,0x47,0x3e,
                0x18,0x82,0x0c,

                        /* 了 */
                0x00,0x00,0x00,
                0x00,0x00,0x18,
                0x3f,0xff,0xfc,
                0x00,0x00,0x18,
                0x00,0x00,0x30,
                0x00,0x00,0x60,
                0x00,0x00,0xc0,
                0x00,0x03,0x00,
                0x00,0x0c,0x00,
                0x00,0x0c,0x00,
                0x00,0x0c,0x00,
                0x00,0x0c,0x00,
                0x00,0x0c,0x00,
                0x00,0x0c,0x00,
                0x00,0x0c,0x00,
                0x00,0x0c,0x00,
                0x00,0x0c,0x00,
                0x00,0x0c,0x00,
                0x00,0x0c,0x00,
                0x00,0x0c,0x00,
                0x00,0x0c,0x00,
                0x00,0x0c,0x00,
                0x03,0xfc,0x00,
                0x00,0x38,0x00
                };

char msg0[]    = {
                        /*    */
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                        /* 平 */
                0x00,0x00,0x00,
                0x00,0x00,0x18,
                0x3f,0xff,0xfc,
                0x00,0x18,0x00,
                0x00,0x18,0x00,
                0x10,0x18,0x10,
                0x0c,0x18,0x1c,
                0x06,0x18,0x38,
                0x06,0x18,0x30,
                0x03,0x18,0x60,
                0x03,0x18,0x40,
                0x03,0x18,0x80,
                0x00,0x19,0x00,
                0x00,0x18,0x06,
                0xff,0xff,0xff,
                0x00,0x18,0x00,
                0x00,0x18,0x00,
                0x00,0x18,0x00,
                0x00,0x18,0x00,
                0x00,0x18,0x00,
                0x00,0x18,0x00,
                0x00,0x18,0x00,
                0x00,0x18,0x00,
                0x00,0x10,0x00,

                        /*    */
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,

                        /*    */
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,

                        /* 手 */
                0x00,0x00,0x70,
                0x00,0x03,0xf8,
                0x00,0x7f,0x00,
                0x3f,0xf8,0x00,
                0x00,0x18,0x00,
                0x00,0x18,0x00,
                0x00,0x18,0x00,
                0x00,0x18,0x18,
                0x3f,0xff,0xfc,
                0x00,0x18,0x00,
                0x00,0x18,0x00,
                0x00,0x18,0x00,
                0x00,0x18,0x04,
                0x00,0x18,0x0e,
                0xff,0xff,0xff,
                0x00,0x18,0x00,
                0x00,0x18,0x00,
                0x00,0x18,0x00,
                0x00,0x18,0x00,
                0x00,0x18,0x00,
                0x00,0x18,0x00,
                0x00,0x18,0x00,
                0x07,0xf8,0x00,
                0x00,0x70,0x00,

                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00,
                0x00,0x00,0x00
                };

main()          /*    主程式   */
{
    int     gdriver = DETECT, gmode, errorcode;
    int     i, x, y, match = 0, moves;
    int     xmax, ymax;

#ifdef BGI
    registerbgidriver(EGAVGA_driver);
#endif

    initgraph(&gdriver, &gmode, "");    /*  啟動 Turbo C 的繪圖模式 */
    if ((errorcode = graphresult()) != grOk) {
        printf("Graphics error: %s\n", grapherrormsg(errorcode));
        return 1;
    }


    randomize();

    x = ((xmax = getmaxx()) - 50) / 3;
    y = ((ymax = getmaxy()) - 50) / 3;
    width = x < y ? x : y;
    XX    = (xmax - 3 * width) / 2;
    YY    = (ymax - 3 * width) / 2;

    do {
        cleardevice();
        setfillstyle(SOLID_FILL, BackGround);
        bar(0, 0, xmax, ymax);

        init_well();
        for (moves =  match = 0; moves < 9 && ! match; moves++) {
            turn = (turn+1) % 2;
            player[turn].func();
            select();
            if ((match = checkmatch(1)) == 1) {
//              settextstyle(DEFAULT_FONT, HORIZ_DIR, 8);
//              outtextxy(XX+10, YY+width+40, player[turn].message);

                for (i = 1; i <= xmax/2/3-20; i++) {
                    setfillstyle(SOLID_FILL, BoarCOLOR);
                    bar(xmax/2 - i*3, ymax/2 - i, xmax/2 + i*3, ymax/2 + i);
                }
                setcolor(TextCOLOR);
                outcpattern(XX+10, YY+width+30,
                       turn == 0 ? msg1 : msg2, 6, 3, 3);
            }
        }
    } while (getch() != 27);

    closegraph();
    return 0;
}

int checkmatch(int sel)
{
    setlinestyle(SOLID_LINE, 1, THICK_WIDTH);
    setcolor(MatcCOLOR);

    if (well[xx][0] == well[xx][1] && well[xx][0] == well[xx][2]) {
        if (sel)
            line(XX+xx*width+d+width/2, YY+d,
                 XX+xx*width+d+width/2, YY+3*width-d);
        return 1;
    }

    if (well[0][yy] == well[1][yy] && well[0][yy] == well[2][yy]) {
        if (sel)
            line(XX+d        , YY+yy*width+d+width/2,
                 XX+3*width-d, YY+yy*width+d+width/2);
        return 1;
    }

    if (well[1][1] != 0 && well[0][0] == well[1][1] && well[1][1] == well[2][2]) {
        if (sel)
            line(XX+d, YY+d, XX+3*width-d, YY+3*width-d);
        return 1;
    }

    if (well[1][1] != 0 && well[0][2] == well[1][1] && well[1][1] == well[2][0]) {
        if (sel)
            line(XX+3*width-d, YY+d, XX+d, YY+3*width-d);
        return 1;
    }

    return 0;
}

void init_well()
{
    int  i, j;

    setfillstyle(SOLID_FILL, LineCOLOR);
    bar(XX+  width-d, YY+d        , XX+  width+d, YY+3*width-d);
    bar(XX+2*width-d, YY+d        , XX+2*width+d, YY+3*width-d);
    bar(XX+d        , YY+  width-d, XX+3*width-d, YY+  width+d);
    bar(XX+d        , YY+2*width-d, XX+3*width-d, YY+2*width+d);

    for (i = 0; i < 3; i++)
        for (j = 0; j < 3; j++)
            well[i][j] = 0;

    xx = yy = 1;
}

void user_move()
{
    int   k;

    setlinestyle(SOLID_LINE, 1, THICK_WIDTH);
    do {
         while (! kbhit()) {
             setcolor(CursCOLOR);
             rectangle(XX+xx*width+d+1,       YY+yy*width+d+1,
                       XX+xx*width+width-d-1, YY+yy*width+width-d-1);
             delay(30);
             setcolor(BackGround);
             rectangle(XX+xx*width+d+1,       YY+yy*width+d+1,
                       XX+xx*width+width-d-1, YY+yy*width+width-d-1);
             delay(30);
         }
         switch(k = getch()) {
         case 72:  /* up    */
             yy = (yy + 2) % 3;
             break;
         case 80:  /* down  */
             yy = (yy + 1) % 3;
             break;
         case 75:  /* left  */
             xx = (xx + 2) % 3;
             break;
         case 77:  /* right */
             xx = (xx + 1) % 3;
             break;
         case '\r' :
         case ' '  :
             if (well[xx][yy] == 0) {
                  well[xx][yy] = 1;
                  k = ' ';
             } else {
                  sound(40);
                  delay(150);
                  nosound();
                  k = 0;
             }
             break;
         }
    } while (k != ' ');
}

void comp_move()
{
    for (xx = 0; xx < 3; xx++) {
        for (yy = 0; yy < 3; yy++) {
            if (well[xx][yy] == 0) {
                well[xx][yy] = 2;
                if (checkmatch(0))
                    return;
                well[xx][yy] = 0;
            }
        }
    }

    for (xx = 0; xx < 3; xx++) {
        for (yy = 0; yy < 3; yy++) {
            if (well[xx][yy] == 0) {
                well[xx][yy] = 1;
                if (checkmatch(0)) {
                    well[xx][yy] = 2;
                    return;
                }
                well[xx][yy] = 0;
            }
        }
    }

    if (well[1][1] == 0) {
         if (random(2)) {
             xx = yy = 1;
             well[xx][yy] = 2;
             return;
         }
    }

    xx = random(3);
    yy = random(3);

    switch(random(4)) {
    case 0:
        xx = yy = 0;
        break;
    case 1:
        xx = 0;
        yy = 2;
        break;
    case 2:
        xx = 2;
        yy = 0;
        break;
    case 3:
        xx = yy = 2;
        break;
    }

    while (well[xx][yy] != 0) {
        xx = random(3);
        yy = random(3);
    }

    well[xx][yy] = 2;
}

void select()
{
    setlinestyle(SOLID_LINE, 1, THICK_WIDTH);
    if (well[xx][yy] == 1) {
        setcolor(UserCOLOR);
        circle(XX+xx*width+d+(width-d)/2, YY+yy*width+d+(width-d)/2, (width-d)/2-20);
    } else {
        setcolor(CompCOLOR);
        line(XX+xx*width+d+7,       YY+yy*width+d+7,
             XX+xx*width+width-d-7, YY+yy*width+width-d-7);
        line(XX+xx*width+width-d-7, YY+yy*width+d+7,
             XX+xx*width+d+7,       YY+yy*width+width-d-7);
    }
}


void outcpattern(int x, int y, char *msg, int len, int xs, int ys)
{
    int  i, j, k, js, ks, m;
    char c;

    for (i = 0; i < len; i++) {
        for (j = 0; j < 24; j++) {
            for (js = 0; js < ys; js++) {
                for (k = 0; k < 3; k++) {
                    for (m = 0, c = *(msg+(i*24+j)*3+k); m < 8; m++) {
                        if (((c >> (7-m)) & 0x01) != 0) {
                            for (ks = 0; ks < xs; ks++) {
                                putpixel(x+(24*i+k*8+m)*xs+ks, y+j*ys+js, getcolor());
                            }
                        }
                    }
                }
            }
        }
    }
}
